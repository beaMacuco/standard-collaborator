{% extends 'base.html' %}

{% block extrahead %}
    <link rel="stylesheet" href="http://assets.annotateit.org/annotator/v1.2.9/annotator.min.css">
{% endblock extrahead %}

{% block extranav %}
{% if request.user.is_authenticated %}
<li><a title="Logout" href="{% url 'auth_logout' %}?next={{ request.path }}"><span class="oi oi-account-logout navicon" aria-hidden="true"></span></a></li>
{% else %}
<li><a title="Login" href="{% url 'auth_login' %}?next={{ request.path }}" title="About"><span class="oi oi-account-login navicon" aria-hidden="true"></span></a></li>
{% endif %}
<li><a href="#" title="Change versions" data-toggle="modal" data-target="#changeVersion"><span class="oi oi-fork navicon" aria-hidden="true"></span></a></li>
{% endblock extranav %}

{% block content %}
    <h1>Open Contracting Data Standard - {{ current_release.display_name }}</h1>
    <p>Last modified: {{ current_release.last_modified }}</p>
    <div class="panel panel-primary">
        <div class="panel-heading">
        <h4 class="panel-title"> <span class="glyphicon glyphicon-question-sign"></span> Share your comments</h4>
        </div>
        <div class="panel-body">
            The online version of this document is open for comment. You can share your comments in two ways:
            <ul>
                <li><strong>Inline comments on the document</strong> - select the <span class="glyphicon glyphicon glyphicon-comment"></span> icon at the top of the page for details of how to add in-line comments on the document. Once authenticated you can highlight any text on the page and add your own shared annotations, or respond to those left by others.</li>
                <li><strong><a href="https://github.com/open-contracting/standard/issues">Issue tracker</a></strong> - you can add issues to the <a href="https://github.com/open-contracting/standard/issues">standard's GitHub issue tracker</a>.</li>
            </ul>
            Throughout this document there are specific questions for consultation included, but you are not limited to responding to these questions: we welcome all input you can offer. 
            
        </div>
    </div>
    <ul class="nav nav-tabs">
        <li class="active"><a href="#tabs-1" data-toggle="tab">Main</a></li>
        <li><a href="#tabs-2" data-toggle="tab">Definitions</a></li>
    </ul>
    <div id="annotatable"> 
        <div class="tab-content">
            <div class="tab-pane active" id="tabs-1"> {{ standard|safe }} </div>
            <div class="tab-pane" id="tabs-2"> {{ vocabulary|safe }} </div>
        </div>
    </div>
    <!-- OVERLAY DIALOGS -->
    <div class="modal fade" id="login" tabindex="-1" role="dialog" aria-labelledby="Login" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Comment</h4>
                </div>
                <div class="modal-body">
                    <p>You must be logged in to comment on the standard.</p>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <div class="modal fade" id="changeVersion" tabindex="-1" role="dialog" aria-labelledby="ChangeVersion" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Change release</h4>
                </div>
                <div class="modal-body">
                    <p>
                        <ul>
                            {% for release in other_releases %}
                            <li><a href="{% url 'standard' release.display_name %}">{{ release.name }}</a> (Released on: {{ release.last_modified }})</li>
                            {% endfor %}

                            {% if not current_release.is_master %}
                            <li><a href="{% url 'standard' 'master' %}">Master</a> - the current working draft of the standard. This is not a release, it is our working copy currently undergoing edits. The last edit was on {{ current_release.last_modified }}</li>
                            {% endif %}
                        </ul>
                    </p>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
{% endblock content %}

{% block javascript %}
    <script src="http://assets.annotateit.org/annotator/v1.2.9/annotator-full.min.js"></script>
    <script>
    jQuery(function ($) {
        var PROJECTNAME = 'ocdsstandard',
            VERSION = '{% if current_release.is_master %}{{ current_release.commit }}{% else %}{{ current_release.display_name }}{% endif %}',
            URI = '{{ request.build_absolute_uri }}',
            SITE_UNIQUE_ID = '{{ site_unique_id }}',
            PAGE_UNIQUE_ID = SITE_UNIQUE_ID + VERSION;

        a = $('#annotatable').annotator(
            {% if not request.user.is_authenticated %}
               { readOnly: true }
            {% endif %}
            );
        a.annotator('setupPlugins', {}, {
            {% if request.user.is_authenticated %}
                Auth: {tokenUrl: '{% url 'token' %}'},
            {% else %}
                Auth: false,
            {% endif %}

            Tags: false,
            Filter: false,
            Store: {
                annotationData: {
                'project': PROJECTNAME,
                'version': VERSION,
                'uri': URI,
                'siteuid': SITE_UNIQUE_ID,
                'pageuid': PAGE_UNIQUE_ID,
                },
                loadFromSearch: {
                'uri': URI,
                'limit': 1000,
                },
            },
            Permissions: {
                showViewPermissionsCheckbox: false,
                showEditPermissionsCheckbox: false,
                user: '{{ request.user.username }}',
                permissions: {
                    'read':   ["group:__world__"],
                    'update': ["{{ request.user.username }}"],
                    'delete': ["{{ request.user.username }}"],
                    'admin':  ["{{ request.user.username }}"],
                },
            },
        });
    });
    </script>
{% endblock javascript %}
